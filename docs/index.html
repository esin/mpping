<html>

<head>
    <title>MPPing :: MiningPool (ₜᵣᵤₑ)Ping utility</title>
</head>

<body>
    <p>pools for test: eu.zec.slushpool.com:4444 us-east.zec.slushpool.com:4444 cn.zec.slushpool.com:4444 grin29-us.f2pool.com:13654 grin29.f2pool.com:13654</p>
    <input id="pooladdr" type="text" name="pooladdr" value="eu1-zcash.flypool.org:3333" /><br />
    <input id="ping" type="button" value="ping" />
    <div>
        <h3>ping statistics</h3>
        <p id="pingStatistics"></p>
    </div>

    <script>
        var btn = document.getElementById("ping"),
            poolConnection = new XMLHttpRequest();
        poolConnection.timeout = 10000;
        var poolList = [];


        async function getDestination(poolAddr, index) {
            try {
                const resp = await fetch("https://66q7gzyjbf.execute-api.eu-west-1.amazonaws.com/v1/destination/?pooladdr=" + poolAddr);
                resp.json().then(function(data) {
                    poolList[index].Destination = data.ipaddresses[0].dest;
                    poolList[index].Country = data.ipaddresses[0].country;
                    poolList[index].FlagURL32 = data.ipaddresses[0].flagurl32;
                });
            } catch (err) {
                console.log(err)
            }
        }

        btn.addEventListener(
            "click",
            function() {
                var poolAddr = document.getElementById("pooladdr").value;
                var parser = document.createElement("a");
                parser.href = "http://" + poolAddr;
                var theTimer;
                var poolParsed = {
                    hostname: parser.hostname,
                    port: parser.port,
                    pingCount: 5,
                    countTimer: theTimer,
                    TotalPacketsSent: 0,
                    TotalPacketsReceived: 0,
                    TotalTimeMin: 0,
                    TotalTimeMax: 0,
                    TotalTime: 0,
                    PoolError: "",
                    Destination: -1,
                    Country: "",
                    FlagURL32: ""
                };
                poolList.push(poolParsed);

                poolList.forEach(function(pool, index) {
                    if (poolList[index].Destination == -1) {
                        poolList[index].Destination = -2
                            //console.log(getDestination(poolList[index].hostname));
                            //var dest;
                            //dest = 
                        getDestination(poolList[index].hostname, index);
                        //poolList[index].Destination = dest; //.ipaddresses[0].dest;
                    }
                    ping(index);
                });
            },
            false
        );

        function ping(poolID) {
            var host = poolList[poolID].hostname;
            var port = poolList[poolID].port;
            var counter = poolList[poolID].pingCount;
            var theTimer = poolList[poolID].countTimer;
            if (counter === 0) {
                clearTimeout(theTimer);
                return;
            }
            var beforeConnect = new Date().getTime();
            try {
                var proto = location.protocol == "https:" ? "https" : "http";
                poolConnection.open("GET", proto + "://" + host + ":" + port, true);
                console.log(poolList[poolID].Destination)
                poolConnection.onreadystatechange = function() {
                    if (poolConnection.readyState == 4) {
                        var firstReply = new Date().getTime();
                        var fromUserToPool = firstReply - beforeConnect;
                        poolList[poolID].TotalPacketsReceived++;
                        poolList[poolID].TotalTime += fromUserToPool;

                        if (
                            fromUserToPool < poolList[poolID].TotalTimeMin ||
                            poolList[poolID].TotalTimeMin === 0
                        ) {
                            poolList[poolID].TotalTimeMin = fromUserToPool;
                        }

                        if (
                            fromUserToPool > poolList[poolID].TotalTimeMax ||
                            poolList[poolID].TotalTimeMax === 0
                        ) {
                            poolList[poolID].TotalTimeMax = fromUserToPool;
                        }

                        var avgTime = 0;
                        if (poolList[poolID].TotalPacketsReceived != 0) {
                            avgTime =
                                poolList[poolID].TotalTime /
                                poolList[poolID].TotalPacketsReceived;
                        }

                        document.getElementById("pingStatistics").innerHTML =
                            host +
                            ":" +
                            port +
                            " MIN/MAX/AVG: " + poolList[poolID].TotalTimeMin +
                            "ms / " + poolList[poolID].TotalTimeMax +
                            "ms / " + avgTime + "ms " +
                            "Destination: " + poolList[poolID].Destination + "km. " +
                            "Country: " + poolList[poolID].Country + " " + "<img src=" + poolList[poolID].FlagURL32 + " alt=" + poolList[poolID].Country + " height=16px>" ;

                        theTimer = setTimeout(function() {
                            poolList[poolID].countTimer = theTimer;
                            ping(poolID);
                        }, 1000);
                        poolList[poolID].pingCount--;
                    }
                };
                poolConnection.ontimeout = function(e) {
                    console.log(e);
                };

                poolConnection.onerror = function(e) {
                    console.log(e);
                };
                try {
                    poolConnection.send();
                    poolList[poolID].TotalPacketsSent++;
                } catch (e) {
                    console.log(e);
                }
            } catch (e) {}
        }
    </script>
</body>

</html>