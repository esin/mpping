<html>

<head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MPPing :: MiningPool (ₜᵣᵤₑ)Ping utility</title>

    <style>
        body {
            font-family: "Lucida Console", Monaco, monospace;
        }
        
        * {
            box-sizing: border-box;
        }
        
        .column {
            float: left;
            width: 16%;
            padding: 0 10px;
        }
        
        .row {
            margin: 0 -5px;
        }
        
        .row:after {
            content: "";
            display: table;
            clear: both;
        }
        
        .card {
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
            /* this adds the "card" effect */
            padding: 16px;
            text-align: left;
            background-color: #f1f1f1;
        }
        /* Responsive columns - one column layout (vertical) on small screens */
        
        @media screen and (max-width: 600px) {
            .column {
                width: 100%;
                display: block;
                margin-bottom: 20px;
            }
        }
        
        div.pingStatistics {
            border: 1px solid #AAAAAA;
            width: 30%;
            text-align: left;
            border-collapse: collapse;
        }
        
        .divTable.pingStatistics .divTableCell,
        .divTable.pingStatistics .divTableHead {
            border: 0px solid #AAAAAA;
        }
        
        .divTable.pingStatistics .divTableBody .divTableCell {
            font-size: 13px;
        }
        
        .pingStatistics .tableFootStyle {
            font-size: 14px;
        }
        
        .pingStatistics .tableFootStyle .links {
            text-align: right;
        }
        
        .pingStatistics .tableFootStyle .links a {
            display: inline-block;
            background: #1C6EA4;
            color: #FFFFFF;
            padding: 2px 8px;
            border-radius: 5px;
        }
        
        .pingStatistics.outerTableFooter {
            border-top: none;
        }
        
        .pingStatistics.outerTableFooter .tableFootStyle {
            padding: 3px 5px;
        }
        
        .divTable {
            display: table;
        }
        
        .divTableRow {
            display: table-row;
        }
        
        .divTableHeading {
            display: table-header-group;
        }
        
        .divTableCell,
        .divTableHead {
            display: table-cell;
        }
        
        .divTableHeading {
            display: table-header-group;
        }
        
        .divTableFoot {
            display: table-footer-group;
        }
        
        .divTableBody {
            display: table-row-group;
        }
    </style>

</head>

<body>
    <br /><br /> <br />
    <p>
        pools for testing: eu.zec.slushpool.com:4444 us-east.zec.slushpool.com:4444 cn.zec.slushpool.com:4444 grin29-us.f2pool.com:13654 grin29.f2pool.com:13654
    </p>
    <br /><br />
    <div id="mainDiv" style="text-align: center">
        <input id="pooladdr" type="text" name="pooladdr" spellcheck="false" placeholder="Enter pool address" />
        <button id="ping" type="submit" class="Button Button--blue Button--large ">
        <span class="Button--text">+</span>
      </button>
    </div>

    <br />


    <div class="row">
        <div class="column">
            <div class="card">
                <div class="divTableRow">
                    <div class="divTableCell">Pool address</div>
                    <div class="divTableCell">1</div>
                </div>
                <div class="divTableRow">
                    <div class="divTableCell">Average RTT</div>
                    <div class="divTableCell">100</div>
                </div>
                <div class="divTableRow">
                    <div class="divTableCell">Min RTT</div>
                    <div class="divTableCell">50</div>
                </div>
                <div class="divTableRow">
                    <div class="divTableCell">Max RTT</div>
                    <div class="divTableCell">200</div>
                </div>
                <div class="divTableRow">
                    <div class="divTableCell">Destination</div>
                    <div class="divTableCell"></div>
                </div>
                <div class="divTableRow">
                    <div class="divTableCell">Location</div>
                    <div class="divTableCell"></div>
                </div>


            </div>
        </div>
    </div>


    <script>
        var btn = document.getElementById("ping"),
            poolAddrEdit = document.getElementById("pooladdr"),
            poolConnection = new XMLHttpRequest();
        poolConnection.timeout = 10000;
        var poolList = [];

        btn.setAttribute("disabled", "true");

        async function getPoolExtInfo(poolAddr, index) {
            try {
                const resp = await fetch(
                    "https://66q7gzyjbf.execute-api.eu-west-1.amazonaws.com/v1/destination/?pooladdr=" +
                    poolAddr
                );
                resp.json().then(function(data) {
                    poolList[index].Destination = data.ipaddresses[0].dest;
                    poolList[index].Country = data.ipaddresses[0].country;
                    poolList[index].FlagURL32 = data.ipaddresses[0].flagurl32;
                    poolList[index].PoolExtInfo = data;
                });
            } catch (err) {
                console.log(err);
            }
        }

        poolAddrEdit.addEventListener("keyup", function() {
            var poolAddr = document.getElementById("pooladdr").value;
            //(stratum[s]?:\/\/)?

            var re = new RegExp("^(stratum:\/\/)?([a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]\.){1,}(?:[a-zA-Z]{2,})(\:([1-9]|[1-5]?[0-9]{2,4}|6[1-4][0-9]{3}|65[1-4][0-9]{2}|655[1-2][0-9]|6553[1-5]))+$");
            if (re.test(poolAddr)) {
                btn.removeAttribute("disabled");
                console.log('here');
            } else {
                btn.setAttribute("disabled", "true");
            }
        });

        btn.addEventListener(
            "click",
            function() {
                var poolAddr = document.getElementById("pooladdr").value;
                var parser = document.createElement("a");
                parser.href = "http://" + poolAddr;
                var theTimer;
                var poolParsed = {
                    hostname: parser.hostname,
                    port: parser.port,
                    pingCount: 5,
                    countTimer: theTimer,
                    TotalPacketsSent: 0,
                    TotalPacketsReceived: 0,
                    TotalTimeMin: 0,
                    TotalTimeMax: 0,
                    TotalTime: 0,
                    PoolError: "",
                    Destination: -1,
                    Country: "",
                    FlagURL32: "",
                    PoolExtInfo: ""
                };
                poolList.push(poolParsed);

                poolList.forEach(function(pool, index) {
                    if (poolList[index].Destination == -1) {
                        poolList[index].Destination = -2;
                        getPoolExtInfo(poolList[index].hostname, index);
                    }
                    ping(index);
                });
            },
            false
        );

        function ping(poolID) {
            var host = poolList[poolID].hostname;
            var port = poolList[poolID].port;
            var counter = poolList[poolID].pingCount;
            var theTimer = poolList[poolID].countTimer;
            if (counter === 0) {
                clearTimeout(theTimer);
                return;
            }
            var beforeConnect = new Date().getTime();
            try {
                var proto = location.protocol == "https:" ? "https" : "http";
                poolConnection.open("GET", proto + "://" + host + ":" + port, true);
                poolConnection.onreadystatechange = function() {
                    if (poolConnection.readyState == 4) {
                        var firstReply = new Date().getTime();
                        var fromUserToPool = firstReply - beforeConnect;
                        poolList[poolID].TotalPacketsReceived++;
                        poolList[poolID].TotalTime += fromUserToPool;

                        if (
                            fromUserToPool < poolList[poolID].TotalTimeMin ||
                            poolList[poolID].TotalTimeMin === 0
                        ) {
                            poolList[poolID].TotalTimeMin = fromUserToPool;
                        }

                        if (
                            fromUserToPool > poolList[poolID].TotalTimeMax ||
                            poolList[poolID].TotalTimeMax === 0
                        ) {
                            poolList[poolID].TotalTimeMax = fromUserToPool;
                        }

                        document.getElementById("poolName").innerHTML = host;

                        var poolIPs = "Pool IPs: ";
                        if (Array.isArray(poolList[poolID].PoolExtInfo.ipaddresses)) {
                            poolList[poolID].PoolExtInfo.ipaddresses.forEach(function(val) {
                                poolIPs = poolIPs + " " + val.ip;
                            });
                        }

                        document.getElementById("poolIPs").innerHTML = poolIPs;

                        var avgTime = 0;
                        if (poolList[poolID].TotalPacketsReceived != 0) {
                            avgTime =
                                poolList[poolID].TotalTime /
                                poolList[poolID].TotalPacketsReceived;
                        }

                        if (avgTime > 1) {
                            avgTime = Math.round(avgTime);
                        }

                        var totalMin, totalMax;
                        totalMin = poolList[poolID].TotalTimeMin;
                        if (totalMin > 1) {
                            totalMin = Math.round(totalMin);
                        }

                        totalMax = poolList[poolID].TotalTimeMax;
                        if (totalMax > 1) {
                            totalMax = Math.round(totalMax);
                        }

                        document.getElementById("poolTTL").innerHTML =
                            " MIN/MAX/AVG: " +
                            totalMin +
                            " ms / " +
                            totalMax +
                            " ms / " +
                            avgTime +
                            " ms";

                        document.getElementById("poolDestination").innerHTML =
                            Math.round(poolList[poolID].Destination) + " km. ";

                        document.getElementById("poolCountry").innerHTML =
                            poolList[poolID].Country +
                            " " +
                            "<img src=" +
                            poolList[poolID].FlagURL32 +
                            " alt=" +
                            poolList[poolID].Country +
                            " height=16px>";

                        theTimer = setTimeout(function() {
                            poolList[poolID].countTimer = theTimer;
                            ping(poolID);
                        }, 1000);
                        poolList[poolID].pingCount--;
                    }
                };
                poolConnection.ontimeout = function(e) {
                    console.log(e);
                };

                poolConnection.onerror = function(e) {
                    console.log(e);
                };
                try {
                    poolConnection.send();
                    poolList[poolID].TotalPacketsSent++;
                } catch (e) {
                    console.log(e);
                }
            } catch (e) {}
        }
    </script>

</body>

</html>