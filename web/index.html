<html>
  <head> </head>

  <body>
    <input
      id="pooladdr"
      type="text"
      name="pooladdr"
      value="eu1-zcash.flypool.org:3333"
    /><br />
    <input id="ping" type="button" value="ping" />
    <div>
      <h3>ping statistics</h3>
      <p id="pingStatistics"></p>
    </div>

    <script>
      var btn = document.getElementById("ping"),
        poolConnection = new XMLHttpRequest();
      poolConnection.timeout = 10000;
      var poolList = [];

      btn.addEventListener(
        "click",
        function() {
          var poolAddr = document.getElementById("pooladdr").value;
          var parser = document.createElement("a");
          parser.href = "http://" + poolAddr;
          var theTimer;
          var poolParsed = {
            hostname: parser.hostname,
            port: parser.port,
            pingCount: 5,
            countTimer: theTimer,
            TotalPacketsSent: 0,
            TotalPacketsReceived: 0,
            TotalTimeMin: 0,
            TotalTimeMax: 0,
            TotalTime: 0,
            PoolError: ""
          };
          poolList.push(poolParsed);

          poolList.forEach(function(pool, index) {
            ping(index);
          });
        },
        false
      );

      function ping(index) {
        var host = poolList[index].hostname;
        var port = poolList[index].port;
        var counter = poolList[index].pingCount;
        var theTimer = poolList[index].countTimer;
        if (counter === 0) {
          clearTimeout(theTimer);
          return;
        }
          var beforeConnect = new Date().getTime();
          try {
            poolConnection.open("GET", "http://" + host + ":" + port, true);

            poolConnection.onreadystatechange = function() {
              if (poolConnection.readyState == 4) {
                var firstReply = new Date().getTime();
                var fromUserToPool = firstReply - beforeConnect;
                document.getElementById("pingStatistics").innerHTML =
                  host + ":" + port + " " + fromUserToPool + "ms";

                theTimer = setTimeout(function() {
                  poolList[index].countTimer = theTimer;
                  ping(index);
                }, 1000);
                poolList[index].pingCount--;
              }
            };
            poolConnection.ontimeout = function(e) {
              console.log(e);
            };

            poolConnection.onerror = function(e) {
              console.log(e);
            };
            try {
              poolConnection.send();
            } catch (e) {
              console.log(e);
            }
          } catch (e) {}
        }
    </script>
  </body>
</html>
